/**
 * Policies Applied:
 * - Policy 11.1: MCP-First for Claude Tools (use MCP over HTTP)
 * - Policy 11.3: MCP Priority Order (MCP > SDK > HTTP)
 * - Policy 12.1: Supabase MCP MANDATORY for database operations
 * - Policy 3.17: Code documentation (file headers, comments)
 */

name: "mcp-supabase"
description: "Supabase MCP integration for database operations, migrations, security audits, and type generation"
version: "1.0.0"
type: "mcp"

mcp_config:
  server_name: "supabase"
  prefix: "mcp__supabase__"
  auto_detect: true
  priority: 10

hooks:
  - name: "database-migration"
    description: "Apply database migration with automatic security/performance validation"
    mcp_tools:
      - "apply_migration"
      - "get_advisors"
    inputs:
      - "project_id"
      - "migration_name"
      - "migration_sql"
    outputs:
      - "migration_result"
      - "advisor_warnings"
    workflow_phases:
      - "execute"
      - "validate"
    required_after:
      - "schema_change"
    validation:
      mandatory: true
      reason: "Policy 12.1 - MUST validate security (RLS) and performance after migrations"

  - name: "database-query"
    description: "Execute SQL query and return results"
    mcp_tools:
      - "execute_sql"
    inputs:
      - "project_id"
      - "query"
    outputs:
      - "query_results"
    workflow_phases:
      - "execute"
      - "validate"
    validation:
      mandatory: false

  - name: "security-audit"
    description: "Run security advisors (RLS policies, vulnerabilities)"
    mcp_tools:
      - "get_advisors"
    inputs:
      - "project_id"
      - "type: security"
    outputs:
      - "security_issues"
    workflow_phases:
      - "validate"
      - "review"
    required_after:
      - "database-migration"
      - "schema_change"
    validation:
      mandatory: true
      reason: "Policy 12.1 - MUST check RLS policies and vulnerabilities"

  - name: "performance-audit"
    description: "Run performance advisors (indexes, query optimization)"
    mcp_tools:
      - "get_advisors"
    inputs:
      - "project_id"
      - "type: performance"
    outputs:
      - "performance_issues"
    workflow_phases:
      - "validate"
      - "review"
    validation:
      mandatory: false

  - name: "type-generation"
    description: "Generate TypeScript types from database schema"
    mcp_tools:
      - "generate_typescript_types"
    inputs:
      - "project_id"
    outputs:
      - "typescript_types_content"
    workflow_phases:
      - "execute"
    auto_trigger_after:
      - "database-migration"
      - "schema_change"
    validation:
      mandatory: false

  - name: "schema-inspection"
    description: "List tables, extensions, and migrations"
    mcp_tools:
      - "list_tables"
      - "list_extensions"
      - "list_migrations"
    inputs:
      - "project_id"
    outputs:
      - "tables_list"
      - "extensions_list"
      - "migrations_list"
    workflow_phases:
      - "load-context"
      - "validate"
    validation:
      mandatory: false

capabilities:
  - "database-operations"
  - "schema-migrations"
  - "security-validation"
  - "performance-optimization"
  - "type-generation"
  - "schema-inspection"

auto_triggers:
  keywords:
    - trigger: ["database", "schema", "migration", "supabase", "db"]
      hooks: ["database-migration", "security-audit"]
      mandatory: true
    - trigger: ["query", "select", "insert", "update", "delete"]
      hooks: ["database-query"]
      mandatory: false
    - trigger: ["types", "typescript", "codegen"]
      hooks: ["type-generation"]
      mandatory: false
    - trigger: ["rls", "security", "vulnerability"]
      hooks: ["security-audit"]
      mandatory: true
    - trigger: ["performance", "optimize", "index"]
      hooks: ["performance-audit"]
      mandatory: false

integration_with_policies:
  - policy: "12.1"
    enforcement: "MANDATORY"
    description: "Supabase MCP must be used for all database operations"
    violations_fail_workflow: true
